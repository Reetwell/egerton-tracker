<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Egerton">
    <meta name="theme-color" content="#f8f8f8">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="egerton-tracker.png">
    <title>Egerton U15 Lions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            });
        }
    </script>
    <style>
        /* ========================================
           CSS VARIABLES & RESET
        ======================================== */
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        :root {
            --color-primary: #FACC15;
            --color-primary-light: #FEF9C3;
            --color-primary-dark: #CA8A04;
            --color-win: #22c55e;
            --color-draw: #FACC15;
            --color-loss: #ef4444;
            --color-home: #15803d;
            --color-away: #1d4ed8;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(0, 0, 0, 0.06);
            --transition-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            background: linear-gradient(180deg, #f8f8f8 0%, #f0f0f5 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
        }

        html {
            overscroll-behavior: none;
        }

        /* ========================================
           GLASS MORPHISM COMPONENTS
        ======================================== */
        .glass-nav {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 0.5px solid rgba(255, 255, 255, 0.6);
            box-shadow: 
                0 -1px 0 rgba(0, 0, 0, 0.04),
                0 8px 32px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -0.5px 0 rgba(0, 0, 0, 0.05);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-bottom: 0.5px solid var(--glass-border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 0.5px solid var(--glass-border);
            box-shadow: 
                0 2px 12px rgba(0, 0, 0, 0.04),
                0 1px 2px rgba(0, 0, 0, 0.02),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .glass-card:active { transform: scale(0.98); }

        .glass-card-yellow {
            background: rgba(254, 249, 195, 0.5);
            border: 0.5px solid rgba(250, 204, 21, 0.3);
            box-shadow: 0 2px 12px rgba(250, 204, 21, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        /* ========================================
           LIQUID GLASS COMPONENTS (Apple-style)
        ======================================== */
        .liquid-glass-nav {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 0.5px solid rgba(0, 0, 0, 0.06);
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.9),
                inset 0 -0.5px 0 rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .liquid-glass-nav::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.5) 0%,
                transparent 50%
            );
            pointer-events: none;
        }

        .liquid-glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 1rem;
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.06),
                0 1px 3px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.25s ease;
        }

        .liquid-glass-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.5) 0%,
                transparent 100%
            );
            border-radius: inherit;
            pointer-events: none;
        }

        .liquid-glass-card:active {
            transform: scale(0.98);
            box-shadow:
                0 2px 12px rgba(0, 0, 0, 0.08),
                0 1px 2px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        /* Tap ripple effect for mobile */
        .liquid-glass-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            opacity: 0;
            transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease;
        }

        .liquid-glass-card:active::before {
            width: 200%;
            height: 200%;
            opacity: 1;
        }

        .liquid-glass-card-yellow {
            background: rgba(254, 252, 232, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(250, 204, 21, 0.4);
            box-shadow:
                0 4px 24px rgba(250, 204, 21, 0.12),
                0 1px 3px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            position: relative;
            overflow: hidden;
        }

        .liquid-glass-card-yellow::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.6) 0%,
                transparent 100%
            );
            border-radius: inherit;
            pointer-events: none;
        }

        /* ========================================
           STAT CARDS
        ======================================== */
        .stat-win { background: rgba(220, 252, 231, 0.6); border-color: rgba(34, 197, 94, 0.2); }
        .stat-draw { background: rgba(254, 249, 195, 0.6); border-color: rgba(250, 204, 21, 0.3); }
        .stat-loss { background: rgba(254, 226, 226, 0.6); border-color: rgba(239, 68, 68, 0.2); }

        /* ========================================
           NAVIGATION
        ======================================== */
        .nav-item {
            transition: all 0.25s var(--transition-smooth);
            position: relative;
        }

        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 5px;
            height: 5px;
            background: var(--color-primary);
            border-radius: 50%;
            transition: transform 0.25s var(--transition-smooth);
        }

        .nav-item.active::after {
            transform: translateX(-50%) scale(1);
        }

        .nav-item:active { transform: scale(0.9); }

        /* ========================================
           SIDEBAR (Desktop) - Liquid Glass
        ======================================== */
        .sidebar {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border-right: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow:
                4px 0 24px rgba(0, 0, 0, 0.04),
                inset -1px 0 0 rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 100%
            );
            animation: sidebarShimmer 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes sidebarShimmer {
            0% { top: -100%; }
            50%, 100% { top: 100%; }
        }

        .sidebar-item {
            border-radius: 12px;
            position: relative;
            overflow: visible;
            transition: transform 0.3s var(--transition-spring), box-shadow 0.3s ease;
        }

        @media (min-width: 768px) {
            .sidebar-item:hover {
                transform: translateX(3px);
                background: rgba(255, 255, 255, 0.4);
            }

            .sidebar-item:active {
                animation: sidebarBounce 0.6s var(--transition-spring);
                transform: translateX(3px);
            }

            .sidebar-item.active {
                transform: translateX(3px);
                background: rgba(250, 204, 21, 0.2);
                box-shadow:
                    0 0 20px rgba(250, 204, 21, 0.4),
                    0 0 40px rgba(250, 204, 21, 0.2),
                    inset 0 0 12px rgba(250, 204, 21, 0.15);
            }

            .sidebar-item.active:hover {
                background: rgba(250, 204, 21, 0.25);
                box-shadow:
                    0 0 25px rgba(250, 204, 21, 0.5),
                    0 0 50px rgba(250, 204, 21, 0.25),
                    inset 0 0 15px rgba(250, 204, 21, 0.2);
            }
        }

        @media (max-width: 767px) {
            .sidebar-item:active { transform: scale(0.97); }
            .sidebar-item.active {
                background: rgba(250, 204, 21, 0.2);
                box-shadow: 0 0 15px rgba(250, 204, 21, 0.3);
            }
        }

        /* ========================================
           ANIMATIONS
        ======================================== */
        .page-content {
            animation: pageFadeIn 0.2s var(--transition-smooth);
        }

        @keyframes pageFadeIn {
            0% { opacity: 0; transform: translateY(8px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes sidebarBounce {
            0% { transform: translateX(3px) scale(1); }
            25% { transform: translateX(3px) scale(0.92); }
            50% { transform: translateX(3px) scale(1.06); }
            75% { transform: translateX(3px) scale(0.97); }
            100% { transform: translateX(3px) scale(1); }
        }

        @keyframes welcomeFadeIn {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes badgeFadeIn {
            0% { opacity: 0; transform: scale(0.8) rotate(-10deg); }
            60% { transform: scale(1.05) rotate(2deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        @keyframes homeSlideIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }

        .welcome-text { animation: welcomeFadeIn 0.6s var(--transition-spring); }
        .badge-animate { animation: badgeFadeIn 0.7s var(--transition-spring); }
        .home-slide-in { animation: homeSlideIn 0.4s var(--transition-smooth); }
        .shake { animation: shake 0.4s ease; }

        /* ========================================
           FORM ELEMENTS
        ======================================== */
        .glass-input {
            background: rgba(255, 255, 255, 0.8);
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.2);
            outline: none;
        }

        .glass-select {
            background: rgba(255, 255, 255, 0.8);
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        .glass-select:focus {
            background-color: rgba(255, 255, 255, 0.95);
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.2);
            outline: none;
        }

        .login-input {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: all 0.3s var(--transition-spring);
        }
        
        .login-input:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--color-primary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(250, 204, 21, 0.2);
            transform: scale(1.02);
            outline: none;
        }

        /* ========================================
           BUTTONS
        ======================================== */
        .btn-primary {
            background: var(--color-primary);
            color: #1f2937;
            transition: all 0.2s ease;
        }
        
        .btn-primary:active {
            transform: scale(0.97);
            background: var(--color-primary-dark);
        }

        .btn-glass {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 0.5px solid rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }
        
        .btn-glass:active { transform: scale(0.97); background: rgba(255, 255, 255, 0.8); }
        .btn-glass.active { background: rgba(250, 204, 21, 0.25); border-color: rgba(250, 204, 21, 0.5); }

        /* ========================================
           PILLS & BADGES
        ======================================== */
        .pill {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 0.5px solid var(--glass-border);
        }
        
        .pill-home { background: rgba(220, 252, 231, 0.7); color: var(--color-home); }
        .pill-away { background: rgba(219, 234, 254, 0.7); color: var(--color-away); }

        .result-w { background: rgba(34, 197, 94, 0.15); color: #15803d; }
        .result-d { background: rgba(250, 204, 21, 0.2); color: #a16207; }
        .result-l { background: rgba(239, 68, 68, 0.15); color: #dc2626; }

        /* ========================================
           UTILITIES
        ======================================== */
        .safe-top { padding-top: env(safe-area-inset-top, 0px); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 0px); }
        .scroll-container { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .number-display { font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; }

        .absent-btn { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .absent-btn.selected { background: rgba(254, 226, 226, 0.8); color: #dc2626; border-color: rgba(239, 68, 68, 0.4); }

        .suggestion-item { transition: all 0.2s ease; }
        .suggestion-item:hover { background: rgba(250, 204, 21, 0.15); }

        /* ========================================
           OVERLAY BACKGROUNDS
        ======================================== */
        .overlay-bg {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .gradient-bg {
            background: linear-gradient(180deg, rgba(250, 204, 21, 0.1) 0%, rgba(255, 255, 255, 0.95) 50%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
    </style>
</head>
<body class="text-gray-900">
    <!-- SVG Filter for Liquid Glass Distortion Effect -->
    <svg style="position:absolute;width:0;height:0;pointer-events:none;">
        <defs>
            <filter id="liquid-glass-distort">
                <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" result="noise"/>
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G"/>
            </filter>
        </defs>
    </svg>
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="w-10 h-10 border-2 border-yellow-400 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p class="text-gray-400 text-sm">Loading...</p>
            </div>
        </div>
    </div>

    <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    const CONFIG = {
        SPREADSHEET_ID: '1sMHiLgwRAsnu2zWRCfdHWwuEMfefpOe30BIo_Zv01IE',
        API_KEY: 'AIzaSyAkb76g25dIADs9Ty5CD3V7BguWe3ahLPs',
        BADGE_IMG: 'egerton-tracker.png',
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycby6a_XWdPHAjEcId0-A57dRG26w_VJlF38lsVuBqnPGzeXAo3RTM76phbB7RA5n9zuwAA/exec',
        ADMIN_PASSCODE: '1505',
        TEAM_NAME: 'Egerton U15 Lions',
        SEASON: '2025/26'
    };

    const STATUS = {
        SCHEDULED: 'Scheduled',
        PLAYED: 'Played',
        POSTPONED: 'Postponed'
    };

    const RESULT = {
        WIN: 'Win',
        DRAW: 'Draw',
        LOSS: 'Loss'
    };

    const APP_STATE = {
        LOGIN: 'login',
        WELCOME: 'welcome',
        BADGE: 'badge',
        MAIN: 'main'
    };

    // ========================================
    // STATE MANAGEMENT
    // ========================================
    const state = {
        app: APP_STATE.LOGIN,
        currentTab: 'overview',
        loggedInPlayer: null,
        allMatches: [],
        fixtures: [],
        results: [],
        players: [],
        messages: [],
        lineups: [],
        resultFilter: null,
        searchOpen: false,
        searchQuery: '',
        selectedPlayer: null,
        selectedMatch: null,
        selectedMatchId: null,
        absentPlayers: [],
        loginInput: '',
        suggestions: [],
        adminUnlocked: false,
        enteredPasscode: '',
        newMessage: '',
        lineupViewOpen: false
    };

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function parseDate(dateStr) {
        if (!dateStr) return null;
        const months = { 'january': 0, 'february': 1, 'march': 2, 'april': 3, 'may': 4, 'june': 5, 'july': 6, 'august': 7, 'september': 8, 'october': 9, 'november': 10, 'december': 11 };
        const parts = dateStr.toLowerCase().split(' ');
        if (parts.length >= 3) {
            const day = parseInt(parts[0]), month = months[parts[1]], year = parseInt(parts[2]);
            if (!isNaN(day) && month !== undefined && !isNaN(year)) return new Date(year, month, day);
        }
        return null;
    }

    function formatShortDate(dateStr) {
        const d = parseDate(dateStr);
        if (!d) return dateStr || '';
        return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    }

    function formatGoalScorers(scorersText, notesText) {
        if (!scorersText || scorersText === 'NO GOALS') return 'No goals';
        const scorers = scorersText.split(',').map(s => s.trim());
        const goalCounts = notesText ? notesText.split(',').map(s => s.trim()) : [];
        return scorers.map((scorer, i) => `${escapeHtml(scorer)} (${goalCounts[i] || '1'})`).join(', ');
    }

    function getResultCounts() {
        return {
            wins: state.results.filter(r => r.result === RESULT.WIN).length,
            draws: state.results.filter(r => r.result === RESULT.DRAW).length,
            losses: state.results.filter(r => r.result === RESULT.LOSS).length
        };
    }

    function getPlayerMessages(playerName) {
        if (!playerName) return [];
        return state.messages.filter(m => 
            m.to.toLowerCase() === playerName.toLowerCase() || 
            m.from.toLowerCase() === playerName.toLowerCase()
        ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    }

    function getNextMatchLineup() {
        const nextMatch = state.fixtures.find(m => m.status?.toLowerCase() === STATUS.SCHEDULED.toLowerCase());
        if (!nextMatch) return null;
        return state.lineups.find(l => l.matchId === nextMatch.id);
    }

    function formatTimestamp(ts) {
        if (!ts) return '';
        const d = new Date(ts);
        if (isNaN(d)) return ts;
        return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
    }

    function openLineupView() {
        state.lineupViewOpen = true;
        renderApp();
    }

    function closeLineupView() {
        state.lineupViewOpen = false;
        renderApp();
    }

    // ========================================
    // DATA FETCHING
    // ========================================
    async function fetchSheetData() {
        try {
            const [fixturesRes, playersRes, messagesRes, lineupsRes] = await Promise.all([
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/Fixtures?key=${CONFIG.API_KEY}`),
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/Players?key=${CONFIG.API_KEY}`),
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/Messages?key=${CONFIG.API_KEY}`).catch(() => ({ json: () => ({}) })),
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/Lineups?key=${CONFIG.API_KEY}`).catch(() => ({ json: () => ({}) }))
            ]);
            
            const fixturesData = await fixturesRes.json();
            const playersData = await playersRes.json();
            const messagesData = await messagesRes.json();
            const lineupsData = await lineupsRes.json();

            if (fixturesData.values?.length > 1) {
                state.allMatches = fixturesData.values.slice(1)
                    .filter(row => row?.length >= 11 && row[0])
                    .map(row => ({
                        id: row[0],
                        date: row[1] || '',
                        dateObj: parseDate(row[1]),
                        kickOffTime: row[2] || '',
                        opponent: row[3] || '',
                        venue: row[4] || '',
                        competition: row[5] || '',
                        ourScore: row[6] || '',
                        goalScorers: row[7] || '',
                        notes: row[8] || '',
                        theirScore: row[9] || '',
                        status: row[10] || '',
                        motm: row[11] || ''
                    }));

                state.fixtures = state.allMatches.filter(m => 
                    m.status?.toLowerCase() === STATUS.SCHEDULED.toLowerCase() || 
                    m.status?.toLowerCase() === STATUS.POSTPONED.toLowerCase()
                );

                state.results = state.allMatches
                    .filter(m => m.status?.toLowerCase() === STATUS.PLAYED.toLowerCase())
                    .map(match => {
                        const ourScore = parseInt(match.ourScore) || 0;
                        const theirScore = parseInt(match.theirScore) || 0;
                        const result = ourScore > theirScore ? RESULT.WIN : ourScore < theirScore ? RESULT.LOSS : RESULT.DRAW;
                        return { ...match, goalsFor: ourScore, goalsAgainst: theirScore, result };
                    })
                    .sort((a, b) => (b.dateObj || 0) - (a.dateObj || 0));
            }

            if (playersData.values?.length > 1) {
                state.players = playersData.values.slice(1)
                    .filter(row => row?.length >= 2 && row[1])
                    .map(row => ({
                        shirtNumber: row[0] || '',
                        name: row[1] || '',
                        position: row[2] || '',
                        goals: parseInt(row[3]) || 0,
                        motm: parseInt(row[4]) || 0,
                        foot: row[5] || '',
                        appearances: parseInt(row[6]) || 0
                    }));
            }

            // Parse Messages: ID, From, FromType, To, Message, Timestamp
            if (messagesData.values?.length > 1) {
                state.messages = messagesData.values.slice(1)
                    .filter(row => row?.length >= 5)
                    .map(row => ({
                        id: row[0] || '',
                        from: row[1] || '',
                        fromType: row[2] || '',
                        to: row[3] || '',
                        message: row[4] || '',
                        timestamp: row[5] || ''
                    }));
            }

            // Parse Lineups: MatchID, Formation, Starting11, Subs, Notes, CreatedBy, Timestamp
            if (lineupsData.values?.length > 1) {
                state.lineups = lineupsData.values.slice(1)
                    .filter(row => row?.length >= 4)
                    .map(row => ({
                        matchId: row[0] || '',
                        formation: row[1] || '',
                        starting11: row[2] ? row[2].split(',').map(s => s.trim()) : [],
                        subs: row[3] ? row[3].split(',').map(s => s.trim()) : [],
                        notes: row[4] || '',
                        createdBy: row[5] || '',
                        timestamp: row[6] || ''
                    }));
            }

            renderApp();
        } catch (error) {
            console.error('Error fetching data:', error);
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-6">
                    <div class="text-center">
                        <p class="text-red-500 mb-4">Error loading data</p>
                        <button onclick="fetchSheetData()" class="btn-primary px-6 py-3 rounded-2xl font-semibold">Retry</button>
                    </div>
                </div>
            `;
        }
    }

    // ========================================
    // LOGIN & AUTHENTICATION
    // ========================================
    function findPlayerMatch(input) {
        if (!input?.trim()) return { exact: null, suggestions: [] };
        
        const inputLower = input.toLowerCase().trim();
        const inputParts = inputLower.split(/\s+/);
        
        // Exact match
        const exactMatch = state.players.find(p => p.name.toLowerCase() === inputLower);
        if (exactMatch) return { exact: exactMatch, suggestions: [] };
        
        // Smart matching
        const matches = state.players.filter(p => {
            const nameLower = p.name.toLowerCase();
            const nameParts = nameLower.split(/\s+/);
            
            if (nameParts[0].startsWith(inputParts[0])) {
                if (inputParts.length > 1 && nameParts.length > 1) {
                    const lastInitial = inputParts[inputParts.length - 1];
                    return nameParts.some(part => part.startsWith(lastInitial));
                }
                return true;
            }
            return nameLower.includes(inputLower);
        });
        
        if (matches.length === 1) return { exact: matches[0], suggestions: [] };
        return { exact: null, suggestions: matches.slice(0, 5) };
    }

    function handleLoginInput(value) {
        state.loginInput = value;
        const result = findPlayerMatch(value);
        state.suggestions = result.suggestions;
        updateSuggestionsDisplay();
    }

    function updateSuggestionsDisplay() {
        const container = document.getElementById('suggestionsContainer');
        if (!container) return;
        
        container.innerHTML = state.suggestions.length > 0 ? `
            <div class="liquid-glass-card rounded-2xl overflow-hidden mb-4">
                <p class="text-xs font-medium text-gray-400 uppercase tracking-wide px-4 pt-3 pb-2">Did you mean?</p>
                ${state.suggestions.map(p => `
                    <div onclick="selectSuggestion('${escapeHtml(p.name)}')" class="suggestion-item flex items-center gap-3 px-4 py-3 cursor-pointer border-t border-gray-100/50">
                        <div class="w-10 h-10 rounded-xl bg-yellow-400 flex items-center justify-center font-bold text-gray-900">${escapeHtml(p.shirtNumber)}</div>
                        <div>
                            <p class="font-medium text-gray-900">${escapeHtml(p.name)}</p>
                            <p class="text-xs text-gray-400">${escapeHtml(p.position)}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        ` : '';
    }

    function attemptLogin() {
        const result = findPlayerMatch(state.loginInput);
        
        if (result.exact) {
            state.loggedInPlayer = result.exact;
            startWelcomeSequence();
        } else if (result.suggestions.length > 0) {
            state.suggestions = result.suggestions;
            updateSuggestionsDisplay();
        } else {
            const input = document.getElementById('loginNameInput');
            if (input) {
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 400);
            }
        }
    }

    function selectSuggestion(playerName) {
        const player = state.players.find(p => p.name === playerName);
        if (player) {
            state.loggedInPlayer = player;
            startWelcomeSequence();
        }
    }

    function loginAsGuest() {
        state.loggedInPlayer = null;
        startWelcomeSequence();
    }

    function startWelcomeSequence() {
        state.app = APP_STATE.WELCOME;
        renderApp();
        
        setTimeout(() => {
            state.app = APP_STATE.BADGE;
            renderApp();
            
            setTimeout(() => {
                state.app = APP_STATE.MAIN;
                renderApp();
            }, 1200);
        }, 1800);
    }

    function logout() {
        state.app = APP_STATE.LOGIN;
        state.loggedInPlayer = null;
        state.loginInput = '';
        state.suggestions = [];
        state.currentTab = 'overview';
        state.adminUnlocked = false;
        state.enteredPasscode = '';
        renderApp();
    }

    // ========================================
    // NAVIGATION & UI ACTIONS
    // ========================================
    function setActiveTab(tab) {
        state.currentTab = tab;
        state.resultFilter = null;
        renderApp();
    }

    function openSearch() {
        state.searchOpen = true;
        state.searchQuery = '';
        renderApp();
        setTimeout(() => document.getElementById('searchInput')?.focus(), 100);
    }

    function closeSearch() {
        state.searchOpen = false;
        state.searchQuery = '';
        renderApp();
    }

    function handleSearch(value) {
        state.searchQuery = value;
        renderApp();
        setTimeout(() => {
            const input = document.getElementById('searchInput');
            if (input) {
                input.focus();
                input.setSelectionRange(value.length, value.length);
            }
        }, 0);
    }

    function getSearchResults() {
        if (!state.searchQuery.trim()) return { players: [], matches: [] };
        const q = state.searchQuery.toLowerCase();
        return {
            players: state.players.filter(p => p.name.toLowerCase().includes(q)),
            matches: state.allMatches.filter(m => m.opponent.toLowerCase().includes(q))
        };
    }

    function openPlayerProfile(playerName) {
        state.selectedPlayer = state.players.find(p => p.name === playerName);
        state.searchOpen = false;
        renderApp();
    }

    function closePlayerProfile() {
        state.selectedPlayer = null;
        renderApp();
    }

    function openMatchDetail(matchId) {
        state.selectedMatch = state.results.find(m => m.id === matchId);
        renderApp();
    }

    function closeMatchDetail() {
        state.selectedMatch = null;
        renderApp();
    }

    function filterResults(type) {
        state.resultFilter = type;
        state.currentTab = 'results';
        renderApp();
    }

    // ========================================
    // PLAYER STATISTICS
    // ========================================
    function getPlayerMatches(playerName) {
        const name = playerName.toLowerCase().trim();
        const firstName = name.split(' ')[0];
        const lastName = name.split(' ').slice(1).join(' ');
        const sameFirstName = state.players.filter(p => p.name.toLowerCase().trim().split(' ')[0] === firstName).length > 1;
        
        return state.results.filter(m => {
            if (!m.goalScorers) return false;
            const scorersLower = m.goalScorers.toLowerCase();
            if (sameFirstName) {
                return scorersLower.includes(name) || (lastName && scorersLower.includes(lastName));
            }
            return scorersLower.includes(name) || scorersLower.includes(firstName);
        }).map(m => {
            const scorers = m.goalScorers.split(',').map(s => s.trim().toLowerCase());
            const goals = m.notes ? m.notes.split(',').map(g => g.trim()) : [];
            let playerGoals = 0;
            
            scorers.forEach((scorer, i) => {
                const matchCondition = sameFirstName
                    ? (scorer.includes(name) || name.includes(scorer) || (lastName && (scorer.includes(lastName) || lastName.includes(scorer))))
                    : (scorer.includes(name) || name.includes(scorer) || scorer.includes(firstName) || firstName === scorer);
                
                if (matchCondition) playerGoals += parseInt(goals[i]) || 1;
            });
            
            return { ...m, playerGoals };
        });
    }

    // ========================================
    // ADMIN FUNCTIONS
    // ========================================
    function enterPasscode(num) {
        if (state.enteredPasscode.length >= 4) return;
        state.enteredPasscode += num.toString();
        updatePasscodeDisplay();
        
        if (state.enteredPasscode.length === 4) {
            setTimeout(() => {
                if (state.enteredPasscode === CONFIG.ADMIN_PASSCODE) {
                    state.adminUnlocked = true;
                    document.getElementById('adminLock')?.classList.add('hidden');
                    document.getElementById('adminContent')?.classList.remove('hidden');
                } else {
                    document.getElementById('passcodeError')?.classList.remove('hidden');
                    document.getElementById('passcodeDisplay')?.classList.add('shake');
                    setTimeout(() => {
                        state.enteredPasscode = '';
                        updatePasscodeDisplay();
                        document.getElementById('passcodeDisplay')?.classList.remove('shake');
                    }, 500);
                }
            }, 100);
        }
    }

    function deletePasscode() {
        state.enteredPasscode = state.enteredPasscode.slice(0, -1);
        updatePasscodeDisplay();
        document.getElementById('passcodeError')?.classList.add('hidden');
    }

    function updatePasscodeDisplay() {
        document.querySelectorAll('.passcode-dot').forEach((dot, i) => {
            dot.classList.toggle('bg-gray-900', i < state.enteredPasscode.length);
            dot.classList.toggle('bg-gray-200', i >= state.enteredPasscode.length);
        });
    }

    function selectMatch(matchId) {
        state.selectedMatchId = matchId;
        state.absentPlayers = [];
        
        const form = document.getElementById('matchForm');
        const cards = document.getElementById('matchCards');
        const match = state.allMatches.find(m => m.id === matchId);
        
        if (!match) return;
        
        cards?.classList.add('hidden');
        form?.classList.remove('hidden');
        
        const matchInfo = document.getElementById('matchInfo');
        if (matchInfo) {
            matchInfo.innerHTML = `
                <p class="text-lg font-semibold text-gray-900">${escapeHtml(match.opponent)}</p>
                <p class="text-sm text-gray-500">${formatShortDate(match.date)} · ${escapeHtml(match.kickOffTime)} · ${escapeHtml(match.venue)}</p>
            `;
        }
        
        const opponentNameEl = document.getElementById('opponentName');
        if (opponentNameEl) opponentNameEl.textContent = match.opponent.split(' ')[0];
        
        // Reset form
        document.getElementById('adminStatus').value = STATUS.SCHEDULED;
        document.getElementById('adminOurScore').value = '';
        document.getElementById('adminTheirScore').value = '';
        document.getElementById('adminGoalScorers').value = '';
        document.getElementById('adminNotes').value = '';
        document.getElementById('adminMOTM').value = '';
        
        document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('scoreSection')?.classList.add('hidden');
    }

    function setStatus(status) {
        document.getElementById('adminStatus').value = status;
        document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-' + status)?.classList.add('active');
        document.getElementById('scoreSection')?.classList.toggle('hidden', status !== STATUS.PLAYED);
    }

    function toggleAbsent(playerName) {
        const btnId = 'absent-' + playerName.replace(/\s+/g, '-');
        const btn = document.getElementById(btnId);
        if (!btn) return;
        
        const index = state.absentPlayers.indexOf(playerName);
        if (index > -1) {
            state.absentPlayers.splice(index, 1);
            btn.classList.remove('bg-red-100', 'text-red-600', 'border-red-300');
            btn.classList.add('bg-white/60', 'text-gray-600', 'border-gray-200');
        } else {
            state.absentPlayers.push(playerName);
            btn.classList.remove('bg-white/60', 'text-gray-600', 'border-gray-200');
            btn.classList.add('bg-red-100', 'text-red-600', 'border-red-300');
        }
    }

    function cancelEdit() {
        state.selectedMatchId = null;
        document.getElementById('matchForm')?.classList.add('hidden');
        document.getElementById('matchCards')?.classList.remove('hidden');
    }

    async function saveMatch() {
        if (!state.selectedMatchId) return showAdminMessage('No match selected', 'error');
        
        const status = document.getElementById('adminStatus').value;
        if (status === STATUS.SCHEDULED) return showAdminMessage('Select status', 'error');
        
        const data = { id: state.selectedMatchId, status };
        
        if (status === STATUS.PLAYED) {
            data.ourScore = document.getElementById('adminOurScore').value || '0';
            data.theirScore = document.getElementById('adminTheirScore').value || '0';
            data.goalScorers = document.getElementById('adminGoalScorers').value || '';
            data.notes = document.getElementById('adminNotes').value || '';
            data.motm = document.getElementById('adminMOTM').value || '';
            data.absentPlayers = state.absentPlayers;
        }
        
        try {
            showAdminMessage('Saving...', 'info');
            await fetch(CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showAdminMessage('Saved ✓', 'success');
            setTimeout(() => {
                state.selectedMatchId = null;
                fetchSheetData();
            }, 1500);
        } catch (error) {
            showAdminMessage('Error saving', 'error');
        }
    }

    function showAdminMessage(text, type) {
        const msg = document.getElementById('adminMessage');
        if (!msg) return;
        msg.classList.remove('hidden', 'text-green-600', 'text-red-500', 'text-blue-500');
        msg.classList.add(type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-500' : 'text-blue-500');
        msg.textContent = text;
    }

    // ========================================
    // COMPONENT RENDERERS
    // ========================================
    function renderStatCard(label, value, colorClass = '', onClick = null) {
        const clickAttr = onClick ? `onclick="${onClick}" class="cursor-pointer"` : '';
        return `
            <div class="liquid-glass-card ${colorClass} rounded-2xl p-3 md:p-4 text-center" ${clickAttr}>
                <p class="text-xs ${colorClass ? '' : 'text-gray-400'} mb-0.5">${label}</p>
                <p class="text-2xl md:text-3xl font-bold number-display">${value}</p>
            </div>
        `;
    }

    function renderPlayerStatsRow(player) {
        return `
            <div class="grid grid-cols-4 gap-2">
                <div class="text-center">
                    <p class="text-2xl font-bold text-gray-900">${player.appearances}</p>
                    <p class="text-[10px] text-gray-400">Apps</p>
                </div>
                <div class="text-center">
                    <p class="text-2xl font-bold text-gray-900">${player.goals}</p>
                    <p class="text-[10px] text-gray-400">Goals</p>
                </div>
                <div class="text-center">
                    <p class="text-2xl font-bold text-yellow-500">${player.motm}</p>
                    <p class="text-[10px] text-gray-400">MOTM</p>
                </div>
                <div class="text-center">
                    <p class="text-2xl font-bold text-gray-900">${player.foot || '-'}</p>
                    <p class="text-[10px] text-gray-400">Foot</p>
                </div>
            </div>
        `;
    }

    function renderMatchCard(match, showGoals = false) {
        const isPlayed = match.status?.toLowerCase() === STATUS.PLAYED.toLowerCase();
        return `
            <div class="liquid-glass-card rounded-2xl p-4 ${isPlayed ? 'cursor-pointer relative' : ''}" ${isPlayed ? `onclick="openMatchDetail('${match.id}')"` : ''}>
                <div class="flex items-center justify-between mb-1">
                    <p class="font-semibold text-gray-900">${escapeHtml(match.opponent)}</p>
                    ${isPlayed ? `
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold number-display">${match.goalsFor}-${match.goalsAgainst}</span>
                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold result-${match.result[0].toLowerCase()}">${match.result[0]}</span>
                        </div>
                    ` : `
                        <span class="pill ${match.venue === 'Home' ? 'pill-home' : 'pill-away'} px-2.5 py-0.5 rounded-full text-xs font-medium">${escapeHtml(match.venue)}</span>
                    `}
                </div>
                <div class="flex items-center justify-between">
                    <p class="text-sm text-gray-500">${formatShortDate(match.date)}${!isPlayed ? ' · ' + escapeHtml(match.kickOffTime) : ''}</p>
                    ${isPlayed ? `<span class="pill ${match.venue === 'Home' ? 'pill-home' : 'pill-away'} px-2.5 py-0.5 rounded-full text-xs font-medium">${escapeHtml(match.venue)}</span>` : ''}
                    ${!isPlayed && match.status === STATUS.POSTPONED ? '<span class="text-xs text-orange-500 font-medium">Postponed</span>' : ''}
                </div>
                ${showGoals && match.goalScorers ? `<p class="text-xs text-gray-400 mt-2">⚽ ${formatGoalScorers(match.goalScorers, match.notes)}</p>` : ''}
                ${isPlayed ? '<svg class="w-4 h-4 text-gray-300 absolute right-4 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>' : ''}
            </div>
        `;
    }

    function renderPlayerCard(player) {
        return `
            <div onclick="openPlayerProfile('${escapeHtml(player.name)}')" class="liquid-glass-card rounded-2xl p-4 cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-11 h-11 rounded-xl bg-yellow-400 flex items-center justify-center font-bold text-gray-900">${escapeHtml(player.shirtNumber)}</div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900">${escapeHtml(player.name)}</p>
                        <p class="text-xs text-gray-400">${escapeHtml(player.position)}${player.foot ? ' · ' + escapeHtml(player.foot) : ''}</p>
                    </div>
                    <div class="flex items-center gap-3 text-center">
                        <div><p class="text-base font-bold number-display">${player.appearances}</p><p class="text-[10px] text-gray-400">Apps</p></div>
                        <div><p class="text-base font-bold number-display">${player.goals}</p><p class="text-[10px] text-gray-400">Goals</p></div>
                        <div><p class="text-base font-bold ${player.motm > 0 ? 'text-yellow-500' : 'text-gray-900'} number-display">${player.motm}</p><p class="text-[10px] text-gray-400">MOTM</p></div>
                    </div>
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </div>
            </div>
        `;
    }

    // ========================================
    // PAGE RENDERERS
    // ========================================
    function renderOverview() {
        const { wins, draws, losses } = getResultCounts();
        const played = state.results.length;
        const topScorers = [...state.players].sort((a, b) => b.goals - a.goals).slice(0, 3);
        const isPlayer = state.loggedInPlayer !== null;

        const nextScheduledMatch = state.fixtures.find(m => m.status?.toLowerCase() === STATUS.SCHEDULED.toLowerCase());

        return `
            <!-- Next Match -->
            ${nextScheduledMatch ? `
                <div class="liquid-glass-card-yellow liquid-glass-card rounded-2xl p-4 mb-4">
                    <p class="text-xs font-medium text-yellow-700 uppercase tracking-wide mb-2">Next Match</p>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-lg font-semibold text-gray-900">${escapeHtml(nextScheduledMatch.opponent)}</p>
                            <p class="text-sm text-gray-500">${formatShortDate(nextScheduledMatch.date)} · ${escapeHtml(nextScheduledMatch.kickOffTime)}</p>
                        </div>
                        <span class="pill ${nextScheduledMatch.venue === 'Home' ? 'pill-home' : 'pill-away'} px-3 py-1 rounded-full text-xs font-medium">${escapeHtml(nextScheduledMatch.venue)}</span>
                    </div>
                </div>
            ` : ''}

            <!-- Lineup Graphic -->
            ${renderLineupGraphic()}

            <!-- Personal Stats -->
            ${isPlayer ? `
                <div class="liquid-glass-card rounded-2xl p-4 mb-4">
                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Your Stats</p>
                    ${renderPlayerStatsRow(state.loggedInPlayer)}
                </div>
            ` : ''}

            <!-- Team Stats -->
            <div class="grid grid-cols-4 gap-2 md:gap-6 mb-4 md:max-w-3xl">
                ${renderStatCard('Played', played)}
                ${renderStatCard('W', wins, 'stat-win text-green-600', "filterResults('Win')")}
                ${renderStatCard('D', draws, 'stat-draw text-yellow-600', "filterResults('Draw')")}
                ${renderStatCard('L', losses, 'stat-loss text-red-500', "filterResults('Loss')")}
            </div>

            <!-- Top Scorers -->
            ${topScorers.length > 0 && topScorers[0].goals > 0 ? `
                <div class="liquid-glass-card rounded-2xl p-4 mb-4">
                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Top Scorers</p>
                    <div class="space-y-3">
                        ${topScorers.filter(p => p.goals > 0).map((player, i) => `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="w-6 h-6 rounded-full ${i === 0 ? 'bg-yellow-400 text-gray-900' : 'bg-gray-100 text-gray-500'} flex items-center justify-center text-xs font-bold">${i + 1}</span>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">${escapeHtml(player.name)}</p>
                                        <p class="text-xs text-gray-400">${escapeHtml(player.position)}</p>
                                    </div>
                                </div>
                                <p class="text-xl font-bold text-gray-900 number-display">${player.goals}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            <!-- Recent Results -->
            ${state.results.length > 0 ? `
                <div class="liquid-glass-card rounded-2xl p-4">
                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Recent</p>
                    <div class="space-y-2">
                        ${state.results.slice(0, 4).map(r => `
                            <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">${escapeHtml(r.opponent)}</p>
                                    <p class="text-xs text-gray-400">${formatShortDate(r.date)}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-base font-bold number-display">${r.goalsFor}-${r.goalsAgainst}</span>
                                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold result-${r.result[0].toLowerCase()}">${r.result[0]}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        `;
    }

    function renderFixtures() {
        return `
            <h2 class="text-xl font-bold text-gray-900 mb-4">Fixtures</h2>
            <div class="space-y-2">
                ${state.fixtures.length > 0 
                    ? state.fixtures.map(f => renderMatchCard(f)).join('')
                    : '<p class="text-gray-400 text-center py-8">No fixtures</p>'
                }
            </div>
        `;
    }

    function renderResults() {
        const filteredResults = state.resultFilter 
            ? state.results.filter(r => r.result === state.resultFilter) 
            : state.results;

        return `
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900">Results</h2>
                ${state.resultFilter ? `<button onclick="state.resultFilter = null; renderApp()" class="text-xs text-yellow-600 font-medium">Clear filter</button>` : ''}
            </div>
            <div class="space-y-2">
                ${filteredResults.length > 0 
                    ? filteredResults.map(r => renderMatchCard(r, true)).join('')
                    : '<p class="text-gray-400 text-center py-8">No results</p>'
                }
            </div>
        `;
    }

    function renderPlayers() {
        return `
            <h2 class="text-xl font-bold text-gray-900 mb-4">Squad</h2>
            <div class="space-y-2">
                ${state.players.length > 0 
                    ? state.players.map(p => renderPlayerCard(p)).join('')
                    : '<p class="text-gray-400 text-center py-8">No players</p>'
                }
            </div>
        `;
    }

    function renderLineupGraphic() {
        const lineup = getNextMatchLineup();
        const nextMatch = state.fixtures.find(m => m.status?.toLowerCase() === STATUS.SCHEDULED.toLowerCase());

        if (!lineup || !nextMatch) return '';

        const playerName = state.loggedInPlayer?.name || '';
        const isInStarting = lineup.starting11.some(p => p.toLowerCase() === playerName.toLowerCase());
        const isInSubs = lineup.subs.some(p => p.toLowerCase() === playerName.toLowerCase());
        const playerStatus = isInStarting ? 'starting' : isInSubs ? 'sub' : '';

        return `
            <div onclick="openLineupView()" class="cursor-pointer rounded-2xl overflow-hidden mb-4" style="background: linear-gradient(135deg, #FACC15 0%, #EAB308 100%); position: relative;">
                <!-- Diagonal stripes -->
                <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 120px; background: repeating-linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.1) 10px, transparent 10px, transparent 20px); transform: rotate(-15deg);"></div>
                <div style="position: absolute; top: 40px; right: 20px; width: 60px; height: 100px; background: repeating-linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.1) 10px, transparent 10px, transparent 20px); transform: rotate(-15deg);"></div>
                
                <div class="p-4 relative">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <img src="${CONFIG.BADGE_IMG}" class="w-8 h-8 rounded-lg" alt="Badge">
                            <div>
                                <p class="text-[10px] font-medium text-gray-800 opacity-70">VS ${escapeHtml(nextMatch.opponent.toUpperCase())}</p>
                                <p class="text-lg font-black text-gray-900 leading-tight">STARTING</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-5xl font-black text-gray-900/10">XI</p>
                        </div>
                    </div>

                    <!-- Starting XI -->
                    <div class="space-y-1 mb-3">
                        ${lineup.starting11.slice(0, 11).map((player, i) => {
                            const p = state.players.find(pl => pl.name.toLowerCase() === player.toLowerCase());
                            const shirtNum = p?.shirtNumber || (i + 1);
                            const isMe = player.toLowerCase() === playerName.toLowerCase();
                            return `
                                <div class="flex items-center gap-2 ${isMe ? 'bg-white/30 -mx-2 px-2 py-0.5 rounded-lg' : ''}">
                                    <span class="w-6 h-6 rounded-md bg-gray-900 text-yellow-400 flex items-center justify-center text-xs font-bold">${shirtNum}</span>
                                    <span class="text-sm font-semibold text-gray-900">${escapeHtml(player.split(' ')[1] || player)}</span>
                                    ${isMe ? '<span class="text-xs bg-gray-900 text-yellow-400 px-1.5 py-0.5 rounded font-bold">YOU</span>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Subs -->
                    ${lineup.subs.length > 0 ? `
                        <div class="border-t border-gray-900/20 pt-2">
                            <p class="text-xs font-bold text-gray-900/70 mb-1 italic">subs</p>
                            <p class="text-xs text-gray-900/80">${lineup.subs.map(s => {
                                const isMe = s.toLowerCase() === playerName.toLowerCase();
                                return isMe ? `<span class="font-bold bg-white/30 px-1 rounded">${escapeHtml(s)}</span>` : escapeHtml(s);
                            }).join(', ')}</p>
                        </div>
                    ` : ''}

                    <!-- Notes -->
                    ${lineup.notes ? `
                        <div class="mt-2 pt-2 border-t border-gray-900/20">
                            <p class="text-xs text-gray-900/70 italic">"${escapeHtml(lineup.notes)}"</p>
                        </div>
                    ` : ''}

                    <!-- Player Status Badge -->
                    ${playerStatus ? `
                        <div class="absolute top-4 right-4">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${playerStatus === 'starting' ? 'bg-gray-900 text-yellow-400' : 'bg-white/50 text-gray-900'}">
                                ${playerStatus === 'starting' ? '⭐ Starting' : '🪑 Sub'}
                            </span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function renderMessages() {
        if (!state.loggedInPlayer) {
            return `
                <h2 class="text-xl font-bold text-gray-900 mb-4">Messages</h2>
                <div class="liquid-glass-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    </div>
                    <p class="text-gray-500">Login as a player to see messages from managers</p>
                </div>
            `;
        }

        const myMessages = getPlayerMessages(state.loggedInPlayer.name);

        return `
            <h2 class="text-xl font-bold text-gray-900 mb-4">Messages</h2>
            ${myMessages.length > 0 ? `
                <div class="liquid-glass-card rounded-2xl p-4">
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        ${myMessages.map(m => {
                            const isFromManager = m.fromType === 'manager';
                            return `
                                <div class="flex ${isFromManager ? 'justify-start' : 'justify-end'}">
                                    <div class="max-w-[80%] ${isFromManager ? 'bg-white border border-gray-100' : 'bg-yellow-400'} rounded-2xl px-4 py-3 shadow-sm">
                                        ${isFromManager ? `<p class="text-xs font-medium text-yellow-600 mb-1">${escapeHtml(m.from)}</p>` : ''}
                                        <p class="text-sm text-gray-900">${escapeHtml(m.message)}</p>
                                        <p class="text-[10px] ${isFromManager ? 'text-gray-400' : 'text-yellow-700'} mt-1">${formatTimestamp(m.timestamp)}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : `
                <div class="liquid-glass-card rounded-2xl p-6 text-center">
                    <div class="w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    </div>
                    <p class="text-gray-500">No messages yet</p>
                    <p class="text-xs text-gray-400 mt-1">Your manager will message you here</p>
                </div>
            `}
        `;
    }

    function renderAdmin() {
        const scheduledMatches = state.allMatches.filter(m => 
            m.status === STATUS.SCHEDULED || m.status === STATUS.POSTPONED
        );

        return `
            <div id="adminLock" class="${state.adminUnlocked ? 'hidden' : ''}">
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-1">Admin Access</h2>
                    <p class="text-sm text-gray-400 mb-6">Enter passcode to continue</p>
                    <div class="flex gap-3 mb-6" id="passcodeDisplay">
                        ${[0,1,2,3].map(() => '<div class="w-3 h-3 rounded-full bg-gray-200 passcode-dot"></div>').join('')}
                    </div>
                    <div id="passcodeError" class="text-red-500 text-sm mb-4 hidden">Incorrect passcode</div>
                    <div class="grid grid-cols-3 gap-4">
                        ${[1,2,3,4,5,6,7,8,9,'',0,'del'].map(n => 
                            n === '' ? '<div></div>' : 
                            n === 'del' ? '<button onclick="deletePasscode()" class="w-16 h-16 rounded-full flex items-center justify-center text-gray-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"/></svg></button>' :
                            `<button onclick="enterPasscode(${n})" class="w-16 h-16 rounded-full liquid-glass-card flex items-center justify-center text-2xl font-light text-gray-900 active:bg-gray-200 transition-colors">${n}</button>`
                        ).join('')}
                    </div>
                </div>
            </div>
            <div id="adminContent" class="${state.adminUnlocked ? '' : 'hidden'}">
                <h2 class="text-xl font-bold text-gray-900 mb-1">Admin</h2>
                <p class="text-sm text-gray-400 mb-4">Update match results</p>
                <div class="space-y-2" id="matchCards">
                    ${scheduledMatches.length > 0 
                        ? scheduledMatches.map(m => `
                            <div onclick="selectMatch('${m.id}')" class="liquid-glass-card rounded-2xl p-4 cursor-pointer">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-semibold text-gray-900">${escapeHtml(m.opponent)}</p>
                                        <p class="text-sm text-gray-500">${formatShortDate(m.date)} · ${escapeHtml(m.kickOffTime)}</p>
                                    </div>
                                    <span class="pill ${m.venue === 'Home' ? 'pill-home' : 'pill-away'} px-2.5 py-0.5 rounded-full text-xs font-medium">${escapeHtml(m.venue)}</span>
                                </div>
                            </div>
                        `).join('')
                        : '<p class="text-gray-400 text-center py-8">No matches to update</p>'
                    }
                </div>
                <div id="matchForm" class="hidden">
                    <div class="liquid-glass-card rounded-2xl p-5">
                        <div id="matchInfo" class="mb-5 pb-4 border-b border-gray-100"></div>
                        <div class="mb-5">
                            <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Status</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setStatus('${STATUS.PLAYED}')" id="btn-${STATUS.PLAYED}" class="status-btn btn-glass py-3 rounded-xl font-medium text-gray-700">Played</button>
                                <button onclick="setStatus('${STATUS.POSTPONED}')" id="btn-${STATUS.POSTPONED}" class="status-btn btn-glass py-3 rounded-xl font-medium text-gray-700">Postponed</button>
                            </div>
                        </div>
                        <div id="scoreSection" class="hidden">
                            <div class="mb-5">
                                <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Score</p>
                                <div class="flex items-center gap-3">
                                    <div class="flex-1">
                                        <p class="text-center text-xs text-gray-400 mb-1">Egerton</p>
                                        <input type="number" id="adminOurScore" min="0" class="glass-input w-full text-center text-2xl font-bold py-3 rounded-xl" placeholder="0">
                                    </div>
                                    <span class="text-xl text-gray-300">-</span>
                                    <div class="flex-1">
                                        <p class="text-center text-xs text-gray-400 mb-1" id="opponentName">Opp</p>
                                        <input type="number" id="adminTheirScore" min="0" class="glass-input w-full text-center text-2xl font-bold py-3 rounded-xl" placeholder="0">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-5">
                                <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Goal Scorers</p>
                                <input type="text" id="adminGoalScorers" class="glass-input w-full py-3 px-4 rounded-xl" placeholder="Name, Name">
                            </div>
                            <div class="mb-5">
                                <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Goals Each</p>
                                <input type="text" id="adminNotes" class="glass-input w-full py-3 px-4 rounded-xl" placeholder="2, 1">
                            </div>
                            <div class="mb-5">
                                <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Man of the Match</p>
                                <select id="adminMOTM" class="glass-select w-full py-3 px-4 rounded-2xl text-gray-900">
                                    <option value="">Select player...</option>
                                    ${state.players.map(p => `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-5">
                                <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Absent Players</p>
                                <p class="text-xs text-gray-400 mb-3">Tap players who didn't attend</p>
                                <div class="flex flex-wrap gap-2" id="absentSelector">
                                    ${state.players.map(p => {
                                        const firstName = p.name.split(' ')[0];
                                        const lastName = p.name.split(' ').slice(1).join(' ');
                                        const hasDuplicate = state.players.filter(pl => pl.name.split(' ')[0] === firstName).length > 1;
                                        const displayName = hasDuplicate && lastName ? firstName + ' ' + lastName.charAt(0) : firstName;
                                        return `
                                        <button type="button" onclick="toggleAbsent('${escapeHtml(p.name)}')" id="absent-${p.name.replace(/\s+/g, '-')}" class="absent-btn px-4 py-2.5 rounded-full text-sm font-medium transition-all bg-white/60 text-gray-600 border border-gray-200 active:scale-95">
                                            ${escapeHtml(displayName)}
                                        </button>
                                    `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="adminStatus" value="${STATUS.SCHEDULED}">
                        <div class="flex gap-2">
                            <button onclick="cancelEdit()" class="flex-1 btn-glass py-3 rounded-xl font-semibold text-gray-700">Cancel</button>
                            <button onclick="saveMatch()" class="flex-1 btn-primary py-3 rounded-xl font-semibold">Save</button>
                        </div>
                        <div id="adminMessage" class="mt-4 text-center text-sm hidden"></div>
                    </div>
                </div>
            </div>
        `;
    }

    // ========================================
    // OVERLAY RENDERERS
    // ========================================
    function renderSearchOverlay() {
        const results = getSearchResults();
        
        return `
            <div id="searchOverlay" class="fixed inset-0 z-50 ${state.searchOpen ? '' : 'hidden'} gradient-bg">
                <div class="flex flex-col items-center justify-center min-h-screen px-4 -mt-20">
                    <img src="${CONFIG.BADGE_IMG}" class="w-20 h-20 rounded-2xl shadow-lg mb-8" alt="Badge">
                    <div class="w-full max-w-2xl">
                        <div class="liquid-glass-card rounded-2xl p-1" style="background: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.8); box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
                            <div class="flex items-center gap-3 px-4 py-3">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                <input type="text" id="searchInput" class="flex-1 bg-transparent text-lg text-gray-900 placeholder-gray-400 focus:outline-none" placeholder="Search players or matches..." oninput="handleSearch(this.value)" value="${escapeHtml(state.searchQuery)}">
                                <button onclick="closeSearch()" class="text-yellow-600 font-medium hover:text-yellow-700">Cancel</button>
                            </div>
                        </div>
                        <div class="mt-4 max-h-80 overflow-y-auto">
                            ${state.searchQuery.length > 0 ? `
                                ${results.players.length > 0 ? `
                                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2 px-2">Players</p>
                                    <div class="space-y-2 mb-4">
                                        ${results.players.map(p => `
                                            <div onclick="openPlayerProfile('${escapeHtml(p.name)}')" class="liquid-glass-card rounded-2xl p-4 cursor-pointer" style="background: rgba(255,255,255,0.8);">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-xl bg-yellow-400 flex items-center justify-center font-bold text-gray-900">${escapeHtml(p.shirtNumber)}</div>
                                                    <div>
                                                        <p class="font-semibold text-gray-900">${escapeHtml(p.name)}</p>
                                                        <p class="text-xs text-gray-400">${escapeHtml(p.position)} · ${p.goals} goals</p>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                ${results.matches.length > 0 ? `
                                    <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2 px-2">Matches</p>
                                    <div class="space-y-2">
                                        ${results.matches.map(m => `
                                            <div class="liquid-glass-card rounded-2xl p-4" style="background: rgba(255,255,255,0.8);">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <p class="font-semibold text-gray-900">${escapeHtml(m.opponent)}</p>
                                                        <p class="text-xs text-gray-400">${formatShortDate(m.date)}</p>
                                                    </div>
                                                    ${m.status?.toLowerCase() === STATUS.PLAYED.toLowerCase() 
                                                        ? `<span class="text-lg font-bold">${m.ourScore}-${m.theirScore}</span>` 
                                                        : `<span class="text-xs text-gray-400">${escapeHtml(m.status)}</span>`
                                                    }
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                ${results.players.length === 0 && results.matches.length === 0 
                                    ? `<p class="text-gray-400 text-center py-8">No results for "${escapeHtml(state.searchQuery)}"</p>` 
                                    : ''
                                }
                            ` : '<p class="text-gray-400 text-center py-4">Search for players or opponents</p>'}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderPlayerProfileOverlay() {
        if (!state.selectedPlayer) return `<div id="playerProfile" class="fixed inset-0 z-50 hidden"></div>`;
        
        const playerMatches = getPlayerMatches(state.selectedPlayer.name);
        
        return `
            <div id="playerProfile" class="fixed inset-0 z-50 overlay-bg">
                <div class="safe-top px-4 py-3 border-b border-gray-100">
                    <button onclick="closePlayerProfile()" class="flex items-center gap-1 text-yellow-600 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Back
                    </button>
                </div>
                <div class="px-4 py-6 overflow-y-auto" style="max-height: calc(100vh - 60px);">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 rounded-2xl bg-yellow-400 flex items-center justify-center text-3xl font-bold text-gray-900 mx-auto mb-3">${escapeHtml(state.selectedPlayer.shirtNumber)}</div>
                        <h1 class="text-2xl font-bold text-gray-900">${escapeHtml(state.selectedPlayer.name)}</h1>
                        <p class="text-gray-500">${escapeHtml(state.selectedPlayer.position)}</p>
                    </div>
                    <div class="grid grid-cols-4 gap-2 mb-6">
                        <div class="liquid-glass-card rounded-2xl p-3 text-center"><p class="text-xl font-bold text-gray-900">${state.selectedPlayer.appearances}</p><p class="text-[10px] text-gray-400">Apps</p></div>
                        <div class="liquid-glass-card rounded-2xl p-3 text-center"><p class="text-xl font-bold text-gray-900">${state.selectedPlayer.goals}</p><p class="text-[10px] text-gray-400">Goals</p></div>
                        <div class="liquid-glass-card rounded-2xl p-3 text-center"><p class="text-xl font-bold text-yellow-500">${state.selectedPlayer.motm}</p><p class="text-[10px] text-gray-400">MOTM</p></div>
                        <div class="liquid-glass-card rounded-2xl p-3 text-center"><p class="text-xl font-bold text-gray-900">${state.selectedPlayer.foot || '-'}</p><p class="text-[10px] text-gray-400">Foot</p></div>
                    </div>
                    ${playerMatches.length > 0 ? `
                        <div class="liquid-glass-card rounded-2xl p-4">
                            <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Matches Scored In</p>
                            <div class="space-y-3">
                                ${playerMatches.map(m => `
                                    <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                                        <div><p class="font-medium text-gray-900">${escapeHtml(m.opponent)}</p><p class="text-xs text-gray-400">${formatShortDate(m.date)}</p></div>
                                        <div class="text-right"><p class="font-bold">${m.ourScore}-${m.theirScore}</p><p class="text-xs text-yellow-600">⚽ ${m.playerGoals}</p></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<div class="liquid-glass-card rounded-2xl p-4"><p class="text-gray-400 text-center py-4">No goals scored yet</p></div>'}
                </div>
            </div>
        `;
    }

    function renderMatchDetailOverlay() {
        if (!state.selectedMatch) return `<div id="matchDetail" class="fixed inset-0 z-50 hidden"></div>`;
        
        const m = state.selectedMatch;
        
        return `
            <div id="matchDetail" class="fixed inset-0 z-50 overlay-bg">
                <div class="safe-top px-4 py-3 border-b border-gray-100">
                    <button onclick="closeMatchDetail()" class="flex items-center gap-1 text-yellow-600 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Results
                    </button>
                </div>
                <div class="px-4 py-6 overflow-y-auto" style="max-height: calc(100vh - 60px);">
                    <div class="text-center mb-6">
                        <p class="text-sm text-gray-400 mb-2">${escapeHtml(m.date)}</p>
                        <p class="text-sm text-gray-500 mb-4">${escapeHtml(m.competition)}</p>
                        <div class="flex items-center justify-center gap-4 mb-4">
                            <div class="text-center">
                                <div class="w-16 h-16 rounded-2xl bg-yellow-400 flex items-center justify-center mb-2 mx-auto"><img src="${CONFIG.BADGE_IMG}" class="w-12 h-12 rounded-xl" alt="Egerton"></div>
                                <p class="text-sm font-medium text-gray-900">Egerton</p>
                            </div>
                            <div class="text-center px-4">
                                <p class="text-4xl font-bold text-gray-900">${m.goalsFor} - ${m.goalsAgainst}</p>
                                <span class="inline-block mt-2 px-3 py-1 rounded-full text-xs font-bold ${m.result === RESULT.WIN ? 'bg-green-100 text-green-700' : m.result === RESULT.DRAW ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${m.result}</span>
                            </div>
                            <div class="text-center">
                                <div class="w-16 h-16 rounded-2xl bg-gray-200 flex items-center justify-center mb-2 mx-auto"><span class="text-2xl">⚽</span></div>
                                <p class="text-sm font-medium text-gray-900">${escapeHtml(m.opponent.split(' ')[0])}</p>
                            </div>
                        </div>
                        <span class="pill ${m.venue === 'Home' ? 'pill-home' : 'pill-away'} px-3 py-1 rounded-full text-xs font-medium">${escapeHtml(m.venue)}</span>
                    </div>
                    <div class="space-y-3">
                        ${m.motm ? `
                            <div class="liquid-glass-card-yellow liquid-glass-card rounded-2xl p-4">
                                <p class="text-xs font-medium text-yellow-700 uppercase tracking-wide mb-2">Man of the Match</p>
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-yellow-400 flex items-center justify-center"><span class="text-lg">⭐</span></div>
                                    <p class="text-lg font-semibold text-gray-900">${escapeHtml(m.motm)}</p>
                                </div>
                            </div>
                        ` : ''}
                        <div class="liquid-glass-card rounded-2xl p-4">
                            <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Goal Scorers</p>
                            ${m.goalScorers && m.goalScorers.trim() && m.goalScorers !== 'NO GOALS' ? `
                                <div class="space-y-2">
                                    ${m.goalScorers.split(',').map((scorer, i) => {
                                        const goals = m.notes ? m.notes.split(',')[i]?.trim() || '1' : '1';
                                        return `<div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0"><div class="flex items-center gap-2"><span class="text-lg">⚽</span><p class="font-medium text-gray-900">${escapeHtml(scorer.trim())}</p></div><p class="text-sm text-gray-500">${goals} goal${goals !== '1' ? 's' : ''}</p></div>`;
                                    }).join('')}
                                </div>
                            ` : '<p class="text-gray-400 text-center py-2">No goals scored</p>'}
                        </div>
                        <div class="liquid-glass-card rounded-2xl p-4">
                            <p class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Details</p>
                            <div class="space-y-2">
                                <div class="flex justify-between"><p class="text-gray-500">Kick-off</p><p class="font-medium text-gray-900">${escapeHtml(m.kickOffTime)}</p></div>
                                <div class="flex justify-between"><p class="text-gray-500">Competition</p><p class="font-medium text-gray-900">${escapeHtml(m.competition || 'League')}</p></div>
                                <div class="flex justify-between"><p class="text-gray-500">Venue</p><p class="font-medium text-gray-900">${escapeHtml(m.venue)}</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ========================================
    // MAIN RENDER FUNCTION
    // ========================================
    function renderApp() {
        const app = document.getElementById('app');
        
        // Login Screen
        if (state.app === APP_STATE.LOGIN) {
            app.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center px-6" style="background: linear-gradient(180deg, rgba(250, 204, 21, 0.08) 0%, rgba(255, 255, 255, 1) 50%);">
                    <div class="w-full max-w-md">
                        <div class="text-center mb-8">
                            <img src="${CONFIG.BADGE_IMG}" class="w-24 h-24 rounded-3xl shadow-lg mx-auto mb-4" alt="Badge">
                            <h1 class="text-2xl font-bold text-gray-900">${CONFIG.TEAM_NAME}</h1>
                            <p class="text-gray-400">Season ${CONFIG.SEASON}</p>
                        </div>
                        <div class="relative mb-4">
                            <input type="text" id="loginNameInput" class="login-input w-full py-4 px-5 rounded-2xl text-lg text-center text-gray-900 placeholder-gray-400" placeholder="Enter your name..." oninput="handleLoginInput(this.value)" onkeydown="if(event.key === 'Enter') attemptLogin()" autocomplete="off" autocapitalize="words">
                        </div>
                        <div id="suggestionsContainer"></div>
                        <button onclick="attemptLogin()" class="btn-primary w-full py-4 rounded-2xl text-lg font-semibold mb-6">Continue</button>
                        <div class="text-center">
                            <button onclick="loginAsGuest()" class="text-gray-400 text-sm hover:text-gray-600 transition-colors">Continue as supporter →</button>
                        </div>
                        <div class="text-center mt-8 pt-6 border-t border-gray-200">
                            <a href="egerton-manager.html" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-yellow-400 text-gray-900 text-sm font-semibold hover:bg-yellow-500 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                Manager Login
                            </a>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => document.getElementById('loginNameInput')?.focus(), 100);
            return;
        }

        // Welcome Screen
        if (state.app === APP_STATE.WELCOME) {
            const name = state.loggedInPlayer ? state.loggedInPlayer.name.split(' ')[0] : 'Supporter';
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center gradient-bg">
                    <div class="text-center welcome-text">
                        <p class="text-gray-400 text-lg mb-2">Welcome,</p>
                        <h1 class="text-4xl font-bold text-gray-900">${escapeHtml(name)}</h1>
                    </div>
                </div>
            `;
            return;
        }

        // Badge Screen
        if (state.app === APP_STATE.BADGE) {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center gradient-bg">
                    <div class="text-center badge-animate">
                        <img src="${CONFIG.BADGE_IMG}" class="w-32 h-32 rounded-3xl shadow-2xl mx-auto" alt="Badge">
                    </div>
                </div>
            `;
            return;
        }

        // Main App
        const isPlayer = state.loggedInPlayer !== null;
        const displayName = isPlayer ? state.loggedInPlayer.name.split(' ')[0] : 'Supporter';
        
        const tabContent = {
            overview: renderOverview,
            fixtures: renderFixtures,
            results: renderResults,
            players: renderPlayers,
            messages: renderMessages,
            admin: renderAdmin
        };

        app.innerHTML = `
            <div class="min-h-screen flex home-slide-in">
                <!-- Sidebar - Desktop -->
                <aside class="sidebar hidden md:flex flex-col w-64 fixed left-0 top-0 bottom-0 z-40 safe-top">
                    <div class="p-4 border-b border-gray-100/50">
                        <div class="flex items-center gap-3">
                            <img src="${CONFIG.BADGE_IMG}" class="w-12 h-12 rounded-xl shadow-sm" alt="Badge">
                            <div>
                                <h1 class="text-base font-semibold text-gray-900">${CONFIG.TEAM_NAME}</h1>
                                <p class="text-xs text-gray-400">Season ${CONFIG.SEASON}</p>
                            </div>
                        </div>
                    </div>
                    <nav class="flex-1 p-3 space-y-1">
                        ${['overview', 'fixtures', 'results', 'players', 'messages', 'admin'].map(tab => `
                            <button onclick="setActiveTab('${tab}')" class="sidebar-item ${state.currentTab === tab ? 'active' : ''} w-full flex items-center gap-3 px-3 py-2.5 text-left">
                                <span class="text-lg">${{overview: '📊', fixtures: '📅', results: '🏆', players: '👥', messages: '💬', admin: '⚙️'}[tab]}</span>
                                <span class="font-medium ${state.currentTab === tab ? 'text-yellow-700' : 'text-gray-700'}">${{overview: 'Overview', fixtures: 'Fixtures', results: 'Results', players: 'Squad', messages: 'Messages', admin: 'Admin'}[tab]}</span>
                            </button>
                        `).join('')}
                    </nav>
                    <div class="p-3 border-t border-gray-100/50">
                        <button onclick="openSearch()" class="sidebar-item w-full flex items-center gap-3 px-3 py-2.5 text-left">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <span class="font-medium text-gray-500">Search</span>
                        </button>
                        <button onclick="logout()" class="sidebar-item w-full flex items-center gap-3 px-3 py-2.5 text-left">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                            <span class="font-medium text-gray-500">Logout</span>
                        </button>
                    </div>
                </aside>

                <!-- Main Content -->
                <div class="flex-1 md:ml-64 flex flex-col min-h-screen">
                    <!-- Header - Mobile -->
                    <header class="liquid-glass-nav safe-top sticky top-0 z-40 px-4 py-3 md:hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img src="${CONFIG.BADGE_IMG}" class="w-9 h-9 rounded-lg shadow-sm" alt="Badge">
                                <div>
                                    <h1 class="text-base font-semibold text-gray-900">${CONFIG.TEAM_NAME}</h1>
                                    <p class="text-xs text-gray-500">${CONFIG.SEASON}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-yellow-100">
                                    ${isPlayer ? `<span class="text-xs font-bold text-yellow-700">${escapeHtml(state.loggedInPlayer.shirtNumber)}</span>` : ''}
                                    <span class="text-xs font-medium text-yellow-700">${escapeHtml(displayName)}</span>
                                </div>
                                <button onclick="openSearch()" class="btn-glass w-9 h-9 rounded-full flex items-center justify-center text-gray-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    <!-- Desktop User Badge -->
                    <div class="hidden md:flex items-center justify-end p-4 gap-3">
                        <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-yellow-100">
                            ${isPlayer ? `<span class="text-sm font-bold text-yellow-700">${escapeHtml(state.loggedInPlayer.shirtNumber)}</span>` : ''}
                            <span class="text-sm font-medium text-yellow-700">${escapeHtml(displayName)}</span>
                        </div>
                        <button onclick="logout()" class="btn-glass px-4 py-2 rounded-full text-sm text-gray-500">Logout</button>
                    </div>

                    ${renderSearchOverlay()}
                    ${renderPlayerProfileOverlay()}
                    ${renderMatchDetailOverlay()}

                    <!-- Page Content -->
                    <main class="flex-1 scroll-container px-4 md:px-8 pb-28 md:pb-8 pt-4 md:pt-2">
                        <div class="page-content">
                            ${tabContent[state.currentTab]()}
                        </div>
                    </main>

                    <!-- Bottom Nav - Mobile -->
                    <nav class="liquid-glass-nav fixed bottom-4 left-4 right-4 rounded-[28px] flex justify-around py-2 z-50 md:hidden">
                        ${['overview', 'fixtures', 'results', 'players', 'messages'].map(tab => `
                            <button onclick="setActiveTab('${tab}')" class="nav-item ${state.currentTab === tab ? 'active' : ''} flex flex-col items-center py-2 px-3">
                                <span class="text-lg mb-0.5 ${state.currentTab === tab ? '' : 'grayscale opacity-60'}">${{overview: '📊', fixtures: '📅', results: '🏆', players: '👥', messages: '💬'}[tab]}</span>
                                <span class="text-[10px] font-medium ${state.currentTab === tab ? 'text-yellow-600' : 'text-gray-400'}">${{overview: 'Home', fixtures: 'Fixtures', results: 'Results', players: 'Squad', messages: 'Chat'}[tab]}</span>
                            </button>
                        `).join('')}
                    </nav>
                </div>
            </div>
        `;
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    document.addEventListener('keydown', (e) => {
        if (state.currentTab !== 'admin' || state.adminUnlocked) return;
        if (e.key >= '0' && e.key <= '9') enterPasscode(parseInt(e.key));
        else if (e.key === 'Backspace' || e.key === 'Delete') deletePasscode();
    });

    // ========================================
    // INITIALIZE
    // ========================================
    fetchSheetData();
    </script>
</body>
</html>
